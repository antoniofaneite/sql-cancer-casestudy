--Accesing data
unzip ~/Downloads/20210601_clinical_trials.zip

CREATE DATABASE tempus_case_study
    WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    CONNECTION LIMIT = -1;
	
--Loading data
/Library/PostgreSQL/13/pgAdmin 4.app/Contents/SharedSupport/pg_restore-host "localhost"
-port "5432" -username "postgres" 
-no-password -dbname "tempus_case_study" -clean 
-verbose "/Users/josefaneite/Downloads/20210601_clinical_trials/postgres_data.dmp";

--Alter search path
ALTER ROLE postgres IN DATABASE tempus_case_study 
SET search_path = ctgov,public;
\q

--Preliminary exploration
--0.1 Tables:
	--Studies
		--Study_type
	--Conditions
	--Eligibilities
	--Countries
	--Facilities
	--Designs
	--Outcome_counts
	--Reported_events
	--Outcome_measurements
	
--0.2 Tables:
-- Joins
-- Expressions
-- Where clause expressions
-- Columns and rows arragement for grouping
-- Add grouping
-- Add having
-- Add order by
-- Tidy up code


--1.0 Data Exploration
SELECT * FROM studies LIMIT (10); 
--Exploring columns

SELECT COUNT(*) as total_number_of_studies 
FROM studies LIMIT 10;
-- 379094 studies in database

SELECT source FROM studies; 
--Specific study site

SELECT DISTINCT study_type 
FROM studies; 

SELECT * FROM studies
WHERE study_type IS NULL; 
--No null values
--Looking for 'Inverventional' studies 

SELECT DISTINCT overall_status  
FROM studies;  

SELECT * FROM studies
WHERE overall_status IS NULL;
-- #No null values
-- #Looking for Completed studies 

SELECT DISTINCT completion_date_type  
FROM studies;

SELECT * FROM studies
WHERE completion_date_type IS NULL
AND official_title LIKE '%ancer%'
AND overall_status = 'Completed'
AND completion_date_type = 'Actual'
OR completion_date_type IS NULL 
AND official_title LIKE '%arcinoma%'
AND overall_status = 'Completed'
AND completion_date_type = 'Actual';

--there are no NULL values in dataset
--Looking for 'actual' completion studies

SELECT * FROM conditions;

SELECT DISTINCT name FROM conditions;
--Condition's names

SELECT * FROM eligibilities; 

SELECT criteria FROM eligibilities; 
--Inclusion/Exclusion criteria
 
SELECT * FROM facilities; 

SELECT *  
FROM facilities
WHERE country IS NULL;

SELECT * FROM facilities
WHERE country = 'United States'
ORDER BY state;
--Country and state location

SELECT * FROM designs;

SELECT DISTINCT primary_purpose 
FROM designs; 
--Type intervention

SELECT * FROM outcome_counts;

SELECT count 
FROM outcome_counts 
LIMIT 10; 
--Number of participants participants

SELECT event_type, subjects_affected
FROM reported_events LIMIT 30; 
--All observed adverse events and outcomes recorded for each trial

SELECT * FROM outcome_measurements 
LIMIT 10;

SELECT DISTINCT param_type FROM outcome_measurements; 

SELECT nct_id, param_value, description
FROM outcome_measurements
WHERE param_value IS NOT NULL
AND param_type = 'Count of Participants'
AND NOT param_value = 'NA'
ORDER BY param_value DESC;
--Most patients with a complete response to the intervention of study


--1.1 Data Exploration
SELECT * FROM studies
WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
ORDER BY nct_id; 

SELECT COUNT(*) AS total_cancer_studies 
FROM studies
WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'; 
--12408 cancer studies in database

SELECT s.nct_id, c.name AS type_of_cancer
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s
INNER JOIN conditions AS c 
	ON c.nct_id = s.nct_id
	WHERE c.name LIKE '%ancer%'
	OR c.name LIKE '%arcinoma%'; 
--16045 cancer conditions; multiple types (cohort) per study

SELECT e.criteria AS inclusion_criteria
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s
INNER JOIN eligibilities AS e 
	ON e.nct_id = s.nct_id; 
--#inclution/exclusion criteria	

SELECT s.nct_id, s.source,
facilities.country, facilities.state
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s, facilities 
WHERE facilities.nct_id = s.nct_id 
	AND facilities.country = 'United States'
	ORDER BY facilities.state; 
--Locations by state

SELECT DISTINCT d.primary_purpose AS types_of_intervention
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s
INNER JOIN designs AS d 
	ON d.nct_id = s.nct_id;
	
--#Intervention of study
--"Diagnostic" = interventions >= 1 being evaluated for identifying cancer
--"Prevention" = interventions >= 1 being assessed for preventing the development of cancer
--"Supportive Care" = interventions >= 1 evaluated for maximizing comfort, minimizing side effects, or mitigating against a decline in the participant's health or function.
--"Treatment" = interventions >= 1 being evaluated for treating cancer
--"Other" = None of the other options applies.

SELECT s.nct_id AS study_id, 
	d.primary_purpose AS type_of_intervention
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s
INNER JOIN designs AS d 
	ON d.nct_id = s.nct_id; 
--Types of interventions

SELECT s.nct_id AS study_id, 
	o.count AS number_of_participants
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual')AS s 
INNER JOIN outcome_counts AS o
	ON o.nct_id = s.nct_id
	GROUP BY s.nct_id , o.count
	ORDER BY o.count DESC; 

SELECT sum(o.count) AS total_number_of_participants
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual')AS s 
INNER JOIN outcome_counts AS o
	ON o.nct_id = s.nct_id; 
--5849959 total participants in all studies

SELECT * FROM reported_events LIMIT 10; 

SELECT s.nct_id, reported_events.event_type, 
	reported_events.subjects_affected,
	reported_events.adverse_event_term
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s
INNER JOIN reported_events 
	ON reported_events.nct_id = s.nct_id
	WHERE subjects_affected IS NOT NULL
	ORDER BY subjects_affected DESC;
--Reported adverse events and outcomes recorded 

--1.2 Data Exploration; joins

SELECT s.nct_id, 
	c.name AS cancer_condition, 
	e.criteria AS inclusion_criteria, 
	f.country AS country,
	f.state AS state, 
	s.source AS institution, 
	d.primary_purpose AS type_of_intervention,
	o.count AS total_number_of_participants
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s
INNER JOIN conditions AS c 
	ON c.nct_id = s.nct_id
INNER JOIN eligibilities as e 
	ON e.nct_id = s.nct_id
INNER JOIN facilities as f 
	ON f.nct_id = s.nct_id 
INNER JOIN designs AS d 
	ON d.nct_id = s.nct_id
INNER JOIN outcome_counts AS o 
	ON o.nct_id = s.nct_id
WHERE f.country = 'United States'
	AND o.count IS NOT NULL
	AND c.name LIKE '%ancer%'
	OR o.count IS NOT NULL
	AND c.name LIKE '%arcinoma%'
GROUP BY o.count,
		s.nct_id,
		c.name,
		e.criteria,
		f.country,
		f.state,
		s.source,
		d.primary_purpose
ORDER BY o.count DESC
	LIMIT 10; 

--2.1 Preparing data; creating general view

CREATE VIEW cancer_studies_general_view AS
SELECT s.nct_id, 
	c.name AS cancer_condition, 
	e.criteria AS inclusion_criteria, 
	f.country AS country,
	f.state AS state, 
	s.source AS institution, 
	d.primary_purpose AS type_of_intervention,
	o.count AS total_number_of_participants
FROM (SELECT * FROM studies
	WHERE study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%ancer%'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
	AND completion_date <= CURRENT_DATE
	AND official_title LIKE '%arcinoma%' 
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%ancer%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual'
		OR study_type = 'Interventional' 
	AND overall_status = 'Completed'
	AND completion_date_type IS NULL
	AND official_title LIKE '%arcinoma%'
	AND study_type = 'Interventional'
	AND overall_status = 'Completed'
	AND completion_date_type = 'Actual') AS s
INNER JOIN conditions AS c 
	ON c.nct_id = s.nct_id
INNER JOIN eligibilities as e 
	ON e.nct_id = s.nct_id
INNER JOIN facilities as f 
	ON f.nct_id = s.nct_id 
INNER JOIN designs AS d 
	ON d.nct_id = s.nct_id
INNER JOIN outcome_counts AS o 
	ON o.nct_id = s.nct_id
WHERE f.country = 'United States'
	AND o.count IS NOT NULL
	AND c.name LIKE '%ancer%'
	OR o.count IS NOT NULL
	AND c.name LIKE '%arcinoma%'
GROUP BY o.count,
		s.nct_id,
		c.name,
		e.criteria,
		f.country,
		f.state,
		s.source,
		d.primary_purpose;

--2.2 Preparing data; view for all observed adverse events and outcomes recorded for each trial
	--Reported_events table subjects_affected, evente_count columns 

CREATE VIEW adverse_events_outcomes AS
SELECT cs.nct_id, rp.event_type AS adverse_outcome, 
		rp.subjects_affected AS participants_affected
FROM reported_events AS rp
INNER JOIN cancer_studies_general_view AS cs 
	ON rp.nct_id = cs.nct_id
GROUP BY cs.nct_id, 
	rp.subjects_affected, 
	rp.event_type;

SELECT * FROM adverse_events_outcomes
LIMIT 10;

--2.3 Preparing data; trial that had the most patients with a complete response to the intervention of study

SELECT cs.nct_id, om.description,
	om.units, om.param_value
FROM outcome_measurements AS om,
	cancer_studies_general_view AS cs
LIMIT 5;

SELECT nct_id, category, units, param_type, 
param_value
FROM outcome_measurements
WHERE category ILIKE 'complete response'
	AND param_value != 'NA'
ORDER BY param_value DESC
LIMIT 20; 


--2.4 Preparing data; trials that started after 2005 and ended before 2010

SELECT cs.nct_id, studies.start_date,
	studies.completion_date 
FROM studies 
JOIN cancer_studies_general_view AS cs 
	ON studies.nct_id = cs.nct_id
	WHERE studies.start_date >= '2006-01-01'
	AND studies.completion_date <= '2010-01-01'
	ORDER BY studies.start_date;
	
--2.5 Preparing data; Distribution of trials by state

SELECT DISTINCT(state) FROM cancer_studies_general_view; 
